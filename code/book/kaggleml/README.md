# 머신러닝 탐구생활

정권우

## Contents

* [1. 파이썬과 머신러닝 그리고 캐글](#1.)
* [2. 산탄데르 제품 추천 경진대회](#2.)
* [3. 텐서플로 음성 인식 경진대회](#3.)
* [4. 포르토 세구로 안전 운전자 예측 경진대회](#4.)
* [5. 스테이트 팜 산만한 운전자 감지 경진대회](#5.)



<br>
<div id='1.'/>
## 1. 파이썬과 머신러닝 그리고 캐글

* 다양한 온라인 경진대회 플랫폼 존재 
   * 해외: Kaggle, DrivenData, CrowdAnalytics, CodaLab, KDD
   * 국내: 빅콘테스트
* 왜 내 아이디어가 모델 성능 개선에 기여했는가/기여하지 못했는가를 이해
   * 문제 고유의 특성을 이해하여 더 좋은 아이디어를 낼 수 있음
   * 머신러닝 알고리즘과 모델링에 대한 직감과 경험을 쌓게됨
* 가장 중요한 목표는 최고의 Private 리더보드 점수를 기록하는 것
   * 데이터 전처리, 교차 검증 기법 선정, 피처 엔지니어링, 모델 튜닝 그리고 앙상블까지의 모든 과정이 튜닝의 요소가 됨
* 대용량 데이터의 경우 데이터의 일부만을 사용하여 학습하는 온라인 학습 기법이 있음
   * Vowpal Wabbit: MS에서 개발함. 선형 모델을 온라인으로 학습하는 라이브러리)
* 캐글 경진대회에서 가장 많이 사용되는 모델은 tree-based 모델임. 
   * 특히, tabular 형태의 데이터가 제공되는 경진대회의 상위 입상자들의 대부분은 gradient boosting, decision trees 라이브러리인 XGBoost, LightGBM, CatBoost를 사용한다.
   * 모델의 다양성을 추가하기 위해 Bagging 기반의 RandomForest, ExtraTrees 모델도 많이 사용 (Scikit-learn)
* 경진대회 데이터의 변수 특징에 따라 때로는 선형 모델(ex. SVM, Logistic Regression)이 트리 모델과 비슷한 수준의 성능을 보일 때도 있음
* 하이퍼 파라미터 최적화 작업에는 hyperopt, scikit-optimize, spearmint 등의 AutoML 라이브러리 사용
* Baseline 모델을 구축하는 이유
   * 머신러닝 파이프라인이 올바르게 동작하는지 확인
   * 새로운 아이디어를 구현한 모델의 성능을 비교할 수 있는 기준점
* 경진대회에서 사용하는 코드는 언제든지 재현할 수 있어야 한다. random_seed를 고정하여 모델의 학습을 재현할 수 있어야 한다.


<br>
<div id='2.'/>
## 2. 산탄데르 제품 추천 경진대회

### 2.1. 경진대회 소개

산탄데르 제품 추천 경진대회. (Multi-class Classification)

생애 첫 부동산을 계약금으로 지불할 준비가 되었는가? 아니면 현재 보유하고 있는 부동산 자산을 활용할 계획이 있는가? 고객의 다양한 재정적 의사결정을 돕기 위하여, 산탄데르 은행은 고객 맞춤형 제품 추천을 제공한다.

현재 산탄데르 은행 시스템은 소수의 고객에게만 다양한 제품 추천을 제공되고, 나머지 고객에게는 제품을 추천할 기회가 적어 불균등한 고객 경험으로 이어지고 있다. 고객의 과거 이력과 유사한 고객군들의 데이터를 기반으로 다음달에 해당 고객이 무슨 제품을 사용할지를 예측하는 문제를 준비하였다.

### 2.2. 경진대회 주최자의 동기

산탄데르 은행은 국내 유수 은행과 같이 고객을 대상으로 예금, 적금, 대출, 신용카드, 자금 관리 및 보험 등 다양한 금융 제품을 판매하며 매출을 올린다. 산탄데르 은행은 자사의 금융 제품을 사용 중인 고객을 대상으로, 아직 고객이 사용하고 있지 않은 다른 금융 제품을 소개하여 고객의 만족도를 높임과 동시에 은행 매출을 올리고 싶어 한다.

고객을 만족시킬 수 있는 가장 좋은 제품 추천 방법은 은행의 숙련된 영업 사원이 고객의 나이, 연봉, 자산, 결혼 유무, 거주 지역, 성격 등의 정보를 토대로 이상적인 자산 계획을 세워주고, 그에 알맞는 적절한 금융 상품을 추천해주는 것이다. 그러나, 매일 은행을 방문하는 고객 모두에게 적절한 추천을 할 수 있는 충분한 숫자의 영업 사원을 고용하는 것이 현실적으로 불가능에 가깝다.

산탄데르 은행은 매일 은행을 방문하는 몇만 명의 고객들 모두에게 1대1 맞춤 수준의 금융 제품 추천을 하기 위하여 머신러닝 알고리즘을 사용하기로 했다.

### 2.3. 평가 척도

산탄데르 제품 추천 경진대회는 고객이 신규로 구매할 제품이 무엇인지를 예측하는 경진대회이다. '신규 구매 제품'이란 지난달 기준으로 고객이 보유하고 있지 않은 금융 제품 중, 이번 달에 신규로 구매하게 되는 제품을 의미하는데, 가령, 6월까지 신용카드를 전혀 사용하지 않던 고객 A가 7월에 신용카드를 사용하게 되었다면, '고객A는 7월에 신용카드를 새로 구매한'것이다.

지난 달에 이미 보유하고 있는 제품을 지속해서 사용하는 것은 신규 구매로 취급하지 않으며, 지난 달에 보유하고 있는 제품을 이번 달에 해지하는 것 또한 신규 구매로 취급하지 않는다.

여러분이 캐글에 제출해야 하는 값은 '고객이 2016-05-228(지난 달) 시점에 보유하고 있지 않은 금융 제품 중, 2016-06-28(이번 달)에 구매할 것으로 예측되는 제품 상위 7개'이다.

평가 척도는 MAP@7(Mean Average Precision @ 7)이다. MAP는 모든 예측 결과물의 Average Precision의 평균값을 의미한다. @7이 붙는 이유는 여러분은 최대 7개의 금융 제품을 예측할 수 있다는 것을 의미한다. MAP@7은 예측 순서에 매우 예민한 평가 척도이다. 앞쪽의 정답을 예측하는 것이 더 좋은 점수를 받을 수 있다. 예측의 정확도를 구할 때는 순서의 인덱스에 맞게 가중치가 붙는다.

```
# Prediction (예측 결과)
1 1 1 1 0 0 0 

# Precision (예측의 정확도)
1/1 2/2 3/3 4/4 0 0 0

# Average Precision (예측 정확도의 평균)
(1/1 + 2/2 + 3/3 + 4/4) / 4 = 1.00
```

반대로, 4개의 정답이 모두 마지막 4개일 경우는 Average Precision은 0.43이다. 

```
# Prediction (예측 결과)
0 0 0 1 1 1 1 

# Precision (예측의 정확도)
0 0 0 1/4 2/5 3/6 4/7

# Average Precision (예측 정확도의 평균)
(1/4 + 2/5 + 3/6 + 4/7) / 4 = 0.43
```

즉, 순위가 높은 케이스를 정답을 맞추는 것이 중요하다. 경진대회에서 MAP@7 평가 척도를 구하기 위해서 `mapk.py` 코드를 사용한다.

### 2.4. 주요 접근

산탄데르 제품 추천 경진대회에서는 Tabular 형태의 시계열(Time-series) 데이터가 제공된다. 시계열 데이터란, 기본적으로 '시간 A에 고객 B가 제품 C를 구매했다'라는 정보가 담긴 데이터를 의미하는데, 데이터에는 고객 B에 대한 다양한 정보(ex. 나이, 직업, 결혼, 고객등급, 거주지역, 국적)가 포함될 수 있다. 뿐만 아니라, 제품 C에도 다양한 정보(ex. 가격, 인기도, 분류, 특징 등)가 담겨있다. 정보가 많다고 무조건 좋은 데이터는 아니다. 모델이 예측해야 하는 정답값(taget value)을 식별하는데 도움이 되는 정보가 많은 데이터가 양질의 데이터이다.

**데이터 전처리 작업**

데이터 수집 과정에서 생길 수 있는 데이터 노이즈가 그대로 반영되기 떄문에, 입력된 값이 없음을 의미하는 결측값(NA or nan), 변수 분포를 따르지 않는 이상치(outlier), 사람의 실수로 인해 잘못 입력된 값, 개인정보 보호를 위해 익명화된 변수 등 다양한 종류의 노이즈가 데이터에 섞여있다. 데이터 탐색적 분석 과정을 통해 어떤 전처리 과정이 필요한지 파악해야 한다.

**피처 엔지니어링**

시계열 데이터를 다루는 경진대회에서는 유의미한 파생 변수를 생성하기 위한 몇 가지 기술들이 있다. 날짜/시간의 정보가 포함된 데이터의 경우, 주중/주말 여부, 공휴일 여부, 아침/낮/밤, 봄/여름/가을/겨울, 학기/시험기간/방학 등 다양한 파생 변수를 생성할 수 있다.

시계열 데이터에서는 과거 데이터를 활용하는 lag데이터를 파생 변수로 생성할 수 있다. 한 달 전, 두 달 전, 세 달 전에 고객 B가 구매한 제품에 대한 데이터를 이번 달에 구매할 제품을 예측하는데 활용한다. 

모든 파생 변수가 모델에 유의미한 것은 아니다. 식별력이 있는 변수는 모델마다, 문제마다 다르기 때문에 모든 가능성을 시도해보는 게 좋다. 실제로, 이번 경진대회에서 lag-5 파생 변수는 유의미한 성능 개선을 이끌어냈다.

Tabular 형태의 시계열 데이터를 다루는 경진대회에서는 딥러닝 모델보다 트리 기반의 앙상블 모델이 더 좋은 성능을 내기도 한다. 특히, XGBoost, LightGBM을 주목하자.

### 2.6. 탐색적 데이터 분석

탐색적 데이터 분석은 크게 두 가지 작업으로 분류할 수 있다. 
* 기초 통계를 통해 raw data를 분석하는 방법
* 시각화를 통해 raw data를 분석하는 방법

**EDA.ipynb** 에 코드와 함께 내용을 정리하였다.

탐색적 데이터 분석(EDA) 결과 정리

* 'age', 'antiguedad', 'indrel_1mes' 등의 수치 변수가 object로 표현되어 있다. 데이터 타입 변환 작업 필요하다.
* 대부분의 고객 변수에 결측값이 존재. 수치형/범주형 변수의 결측값은 기존 변수에 없는 값 (흔히 0, -1 등을 사용)으로 흔히 대체한다. 날짜 변수는 어느 날짜로 대체할지 고민이 필요하다.
* 두 개의 고유 값을 가지는 이진 변수들이 많이 존재한다. 메모리의 효율을 극대화하기 위하여 int64의 0, 1값으로 변환하자.
* 고객 등급, 고객 관계 유형 등 변수의 각 값이 무엇을 의미하는지 구체적인 설명이 부족하다. 예를 들어, 월초 기준 고객 등급을 의미하는 'indrel_1mes'의 '3: former primary' 값이 정확히 무엇을 의미하는지 자세한 설명이 생략되어 있다.
* 여러분이 예측하고자 하는 값은 금융 제품 보유 여부가 아닌, 신규 구매이다. 그러므로 제공된 데이터에서 '신규 구매' 여부를 별도로 추출해야 한다. 평가 기준도 '신규 구매' 기준으로 진행되어야 한다. (cf. labels.csv)
* 신규 구매 데이터가 계절성을 띄고 있다. 단일 모델로 모든 데이터를 학습시킬지, 특정 월만 추출해서 학습을 진행할지 선택이 필요하다. 다수의 모델을 서로 다른 계절을 기반으로 학습하는 것도 또 하나의 방법이다.

### 2.7. Baseline 모델














<br>
<div id='3.'/>
## 3. 텐서플로 음성 인식 경진대회




<br>
<div id='4.'/>
## 4. 포르토 세구로 안전 운전자 예측 경진대회




<br>
<div id='5.'/>
## 5. 스테이트 팜 산만한 운전자 감지 경진대회










